<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ... styles unchanged ... */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4f8;
      margin: 2rem;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .table-responsive {
      width: 100%;
      max-width: 1200px;
      overflow-x: auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 700px;
      background: white;
    }
    thead {
      background: linear-gradient(90deg, #004e92, #000428);
      color: white;
      font-weight: 700;
      font-size: 0.95rem;
      text-align: left;
      user-select: none;
      cursor: pointer;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    thead th {
      padding: 12px 16px;
      position: relative;
      background: inherit;
    }
    thead th.sort-asc::after {
      content: " ▲";
      position: absolute;
      right: 10px;
    }
    thead th.sort-desc::after {
      content: " ▼";
      position: absolute;
      right: 10px;
    }
    tbody tr {
      transition: background-color 0.25s ease;
      cursor: default;
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    tbody tr:hover {
      background: #e1eaff;
    }
    tbody td {
      padding: 12px 16px;
      font-size: 0.9rem;
      border-bottom: 1px solid #ddd;
      white-space: nowrap;
    }
    h2 {
      max-width: 1200px;
      width: 100%;
      margin: 0 0 1rem 0;
      font-weight: 700;
      font-size: 1.5rem;
      background: linear-gradient(90deg, #6a11cb, #2575fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    ul#highlight-list {
      max-width: 1200px;
      width: 100%;
      background: white;
      border-radius: 10px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      padding: 1rem 1.5rem;
      list-style: inside disc;
      color: #444;
      font-size: 0.95rem;
      line-height: 1.5;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 2rem;
    }
    .chart-container {
      width: 90%;
      max-width: 1200px;
      height: 400px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 3rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .chart-container:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    }
    /* Mobile styles */
    @media (max-width: 800px) {
      body {
        margin: 0.5rem;
      }
      .table-responsive {
        border-radius: 0;
        box-shadow: none;
      }
      table {
        min-width: 600px;
        font-size: 0.86rem;
      }
      thead th, tbody td {
        padding: 8px 8px;
        font-size: 0.8rem;
      }
      h2 {
        font-size: 1.1rem;
      }
      .chart-container {
        padding: 2vw;
        height: 250px;
      }
      ul#highlight-list {
        padding: 0.5rem 0.7rem;
        font-size: 0.85rem;
      }
    }
    @media (max-width: 600px) {
      table {
        min-width: 480px;
        font-size: 0.8rem;
      }
      thead th, tbody td {
        padding: 6px 6px;
        font-size: 0.75rem;
      }
      .chart-container {
        height: 180px;
      }
      h2 {
        font-size: 0.98rem;
      }
    }
  </style>
</head>
<body>

  <div class="table-responsive">
    <table id="leaderboard" aria-label="Leaderboard table">
      <thead>
        <tr>
          <th data-key="platz">Platz</th>
          <th data-key="spieler">Spieler</th>
          <th data-key="spiele">Spiele</th>
          <th data-key="punkte">Punkte</th>
          <th data-key="avg">ø P.p.S</th>
          <th data-key="meister">Meister</th>
          <th data-key="letzter">Letzter</th>
          <th data-key="spieltagssiege">Spieltagssiege</th>
          <th data-key="spieltagsletzter">Spieltagsletzter</th>
          <th data-key="tabellenerster">Tabellenerster</th>
          <th data-key="tabellenletzter">Tabellenletzter</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h2>Fiebertabelle</h2>
  <div class="chart-container">
    <canvas id="fieberkurveChart"></canvas>
  </div>

  <h2>Highlights</h2>
  <ul id="highlight-list"></ul>

  <script>
    // --------- CENTRALIZED DATA FROM EASY STATS DASHBOARD ----------
    // For demo, just 5 gamedays. You can expand as needed.
    const rawStats = `
Markus 63, 24, 55, 96, 25
Erwin 48, 55, 69, 88, 20
Phil 76, 49, 72, 54, 85
Didi 50, 52, 61, 74, 41
Steffo 53, 58, 44, 62, 39
Basti 47, 51, 68, 70, 26
Eirik 46, 32, 79, 63, 37
Emil 61, 39, 59, 60, 32
Kempka 36, 41, 57, 52, 40
Espen 57, 62, 65, 66, 28
Alex 55, 37, 64, 59, 38
`;

    // Parse rawStats
    function parseRawStats(raw) {
      const lines = raw.trim().split('\n');
      const players = [];
      const pointsByPlayer = {};
      let maxGames = 0;
      lines.forEach((line, idx) => {
        const [name, ...rest] = line.split(/[\s,]+/);
        const points = line.replace(name, '').split(/[, ]+/).filter(s => s).map(Number);
        players.push(name);
        pointsByPlayer[name] = points;
        if (points.length > maxGames) maxGames = points.length;
      });
      return { players, pointsByPlayer, maxGames };
    }

    const { players, pointsByPlayer, maxGames } = parseRawStats(rawStats);

    // Build matchday data
    const matchdays = Array.from({length: maxGames}, (_, i) => i + 1);
    const matches = matchdays.map(md => {
      const stats = {};
      players.forEach(p => {
        stats[p] = { points: pointsByPlayer[p][md-1] ?? 0 };
      });
      return { matchday: md, stats };
    });

    // Calculate rankings per matchday
    matches.forEach(m => {
      const ranking = players
        .map(p => ({ name: p, points: m.stats[p].points }))
        .sort((a,b) => b.points - a.points);
      ranking.forEach((r, idx) => {
        m.stats[r.name].place = idx + 1;
      });
    });

    // Helper: get cumulative points for Fiebertabelle
    function getCumulativePoints(p) {
      let sum = 0;
      return matches.map(m => {
        sum += m.stats[p].points;
        return sum;
      });
    }

    // Tabellenplatzentwicklung (total points after each matchday)
    function getTabellenplatzentwicklung(p) {
      let runningTotal = 0;
      const platz = [];
      for (let i = 0; i < matches.length; i++) {
        runningTotal += matches[i].stats[p].points;
        // For this matchday, sort all players
        const totals = players.map(pl => ({
          name: pl,
          pts: matches.slice(0, i+1).reduce((sum, m) => sum + m.stats[pl].points, 0)
        })).sort((a,b) => b.pts - a.pts);
        const place = totals.findIndex(t => t.name === p) + 1;
        platz.push(place);
      }
      return platz;
    }

    // Build leaderboardData from raw stats
    function buildLeaderboardData() {
      // Compute all stats for leaderboard
      const data = players.map((p, idx) => {
        const spiele = pointsByPlayer[p].length;
        const punkte = pointsByPlayer[p].reduce((a,b) => a+b, 0);
        const avg = spiele ? Math.round((punkte/spiele)*100)/100 : '-';
        const spieltagssiege = matches.filter(m => m.stats[p].place === 1).length;
        const spieltagsletzter = matches.filter(m => m.stats[p].place === players.length).length;
        const tabellenentwicklung = getTabellenplatzentwicklung(p);
        const tabellenerster = tabellenentwicklung.filter(pl => pl === 1).length;
        const tabellenletzter = tabellenentwicklung.filter(pl => pl === players.length).length;
        return {
          platz: idx + 1,
          spieler: p,
          spiele,
          punkte,
          avg,
          meister: 0, // Set manually if needed
          letzter: 0, // Set manually if needed
          spieltagssiege,
          spieltagsletzter,
          tabellenerster,
          tabellenletzter
        };
      });
      // Sort by punkte descending and update platz
      data.sort((a,b)=>b.punkte-a.punkte);
      data.forEach((d,i)=>d.platz = i+1);
      return data;
    }

    const leaderboardData = buildLeaderboardData();

    // Helper to check if value is numeric
    function isNumeric(value) {
      return !isNaN(parseFloat(value)) && isFinite(value);
    }

    // Render leaderboard rows
    function renderLeaderboard(data) {
      const tbody = document.querySelector("#leaderboard tbody");
      tbody.innerHTML = '';
      data.forEach(player => {
        const row = document.createElement("tr");
        for (const key of [
          'platz',
          'spieler',
          'spiele',
          'punkte',
          'avg',
          'meister',
          'letzter',
          'spieltagssiege',
          'spieltagsletzter',
          'tabellenerster',
          'tabellenletzter'
        ]) {
          const cell = document.createElement("td");
          let val = player[key];
          if (val === null || val === undefined || val === '') {
            val = '-';
          }
          cell.textContent = val;
          row.appendChild(cell);
        }
        tbody.appendChild(row);
      });
    }

    // Sorting variables
    let currentSortKey = 'punkte';
    let currentSortAsc = false;

    function sortLeaderboard(data, key, asc) {
      return data.slice().sort((a, b) => {
        let valA = a[key];
        let valB = b[key];

        // Treat null/empty as lowest
        if (valA === '' || valA === null || valA === undefined) valA = asc ? -Infinity : Infinity;
        if (valB === '' || valB === null || valB === undefined) valB = asc ? -Infinity : Infinity;

        if (isNumeric(valA) && isNumeric(valB)) {
          return asc ? valA - valB : valB - valA;
        } else {
          // Text comparison
          valA = valA.toString();
          valB = valB.toString();
          return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }
      });
    }

    function clearSortIndicators() {
      document.querySelectorAll("#leaderboard thead th").forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
      });
    }

    function updateSortIndicator(th, asc) {
      th.classList.add(asc ? 'sort-asc' : 'sort-desc');
    }

    // Setup sorting event listeners on headers
    document.querySelectorAll("#leaderboard thead th").forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        if (!key) return;

        if (currentSortKey === key) {
          currentSortAsc = !currentSortAsc;
        } else {
          currentSortKey = key;
          currentSortAsc = false; // default descending
        }

        clearSortIndicators();
        updateSortIndicator(th, currentSortAsc);

        const sortedData = sortLeaderboard(leaderboardData, currentSortKey, currentSortAsc);
        renderLeaderboard(sortedData);
      });
    });

    // Initial render & indicator
    renderLeaderboard(sortLeaderboard(leaderboardData, currentSortKey, currentSortAsc));
    document.querySelector("#leaderboard thead th[data-key='punkte']").classList.add('sort-desc');

    // Populate highlights list (unchanged)
    const highlights = [
      "=== Highlights der Saison 25-26 ===",
      "- Keine Spieltagssiege in der Saison ",
      "- Keine Spieltagsniederlagen von ",
      "- Höchste Spieltagpunkte von  ",
      "- Niedrigste Spieltagspunkte von ",
      "-  Spieltagssiege in Folge ",
      "-  Spieltagsniederlagen in Folge von ",
      "- Schlechtester Erster:",
      "- Bester Letzter:",
      "-  Spieltagssiege von ",
      "-  Spieltagsniederlagen von ",
      "",
      "",
      "",
      "",
      "=== Ewige Bestplatzierungen ===",
      "27. Markus mit 108 Punkten 22/23",
      "36. Phil mit 93 Punkten 22/23",
      "108. Phil mit 104 Punkten 24/25",
      "278. Phil mit 91 Punkten 22/23",
      "444. Markus mit 104 Punkten 20/21",
      "614. Phil mit 87 Punkten 22/23",
      "739. Eirik mit 93* Punkten 20/21",
      "766. Phil mit 96 Punkten 21/22",
      "984. Didi mit 91 Punkten 23/24",
      "989. Markus mit 94 Punkten 23/24",
      "",
      "",
      "",
      "",
      "=== Ewige Statistiken ===",
      "- Meiste Spieltagssiege in einer Saison vom Markus mit 13 (21/22)",
      "- Meiste Spieltagsniederlagen in einer Saison von Steffo mit 15 (21/22)",
      "- Ewig wenigste Punkte für Spieltagssieg von Erwin mit 31* Punkten (20/21)",
      "- Ewig wenigste Punkte von Phil mit -9 (22/23) (nur 20 Leute haben weniger punkte gemacht)",
      "- Ewig Höchstpunktzahl von Emil mit 113 (23/24) (leider nicht unter den Top 1000 an dem Spieltag)",
      "",
      "",
      "",
      "",
      "=== Meister ===",
      "- Meister 2021: Eirik mit 1847* Punkten (1609 Ø Punkte in der Liga)",
      "- Meister 2022: Phil mit 1826 Punkten (1481 Ø Punkte in der Liga)",
      "- Meister 2023: Erwin mit 1957 Punkten (1541 Ø Punkte in der Liga)",
      "- Meister 2024: Markus mit 2224 Punkten (1799 Ø Punkte in der Liga)",
      "- Meister 2025: Espen mit 2042 Punkten (1686 Ø Punkte in der Liga)",
      "",
      "",
      "",
      "=== Fussnoten ===",
      "-*in der Saison 20/21 gab es nur zwei Punkte für Startelf und einen für Einwechslung, habe alles nachgeschaut und an die fehlende Punkte addiert (ist ab 2024 in der Ewigen Tabelle miteinberechnet",
      "-Seit der Saison 24/25 gibt es 2 Punkte anstelle von einem für eine Vorlage. Ist mir Wurst, werde das nicht alles neu nachrechnen!"
    ];
    const highlightList = document.getElementById("highlight-list");
    highlights.forEach(text => {
      const li = document.createElement("li");
      li.textContent = text;
      highlightList.appendChild(li);
    });

    // -------- Fiebertabelle from rawStats --------
    // Chart colors for each player
    const colors = [
      '#E41A1C','#377EB8','#4DAF4A','#984EA3','#FF7F00',
      '#A65628','#F781BF','#999999','#66C2A5','#FFD92F','#000000'
    ];
    const datasets = players.map((name, i) => ({
      label: name,
      data: getCumulativePoints(name),
      borderColor: colors[i],
      backgroundColor: colors[i],
      fill: false,
      pointRadius: 3,
      borderWidth: 2,
      spanGaps: true,
      hidden: false,
      opacity: 1
    }));

    const ctx = document.getElementById('fieberkurveChart').getContext('2d');
    const selectedIndices = new Set();

    const fieberChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: matchdays.map(s => `ST${s}`),
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              pointStyle: 'circle',
              color: '#222'
            },
            onClick: (e, legendItem) => {
              const index = legendItem.datasetIndex;
              if (selectedIndices.has(index)) {
                selectedIndices.delete(index);
              } else {
                selectedIndices.add(index);
              }

              if (selectedIndices.size === 0) {
                // Reset all
                fieberChart.data.datasets.forEach((ds, i) => {
                  ds.borderColor = colors[i];
                  ds.backgroundColor = colors[i];
                  ds.borderWidth = 2;
                  ds.hidden = false;
                  ds.opacity = 1;
                });
              } else {
                fieberChart.data.datasets.forEach((ds, i) => {
                  if (selectedIndices.has(i)) {
                    ds.borderColor = colors[i];
                    ds.backgroundColor = colors[i];
                    ds.borderWidth = 4;
                    ds.hidden = false;
                    ds.opacity = 1;
                  } else {
                    ds.borderColor = '#ccc';
                    ds.backgroundColor = '#ccc';
                    ds.borderWidth = 1;
                    ds.hidden = false;
                    ds.opacity = 0.3;
                  }
                });
              }
              fieberChart.update();
            }
          },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y ?? '–'}`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Cumulative Points'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Spieltag'
            }
          }
        }
      },
      plugins: [{
        id: 'opacityPlugin',
        beforeDatasetsDraw(chart) {
          const ctx = chart.ctx;
          chart.data.datasets.forEach(ds => {
            ctx.save();
            ctx.globalAlpha = ds.opacity !== undefined ? ds.opacity : 1;
            ctx.restore();
          });
        }
      }]
    });
  </script>

</body>
</html>
