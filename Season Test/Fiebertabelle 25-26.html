<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fiebertabelle Saisonpunkte</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: 'Segoe UI', Roboto, sans-serif;
  margin: 0; padding: 0;
  display: flex; flex-direction: column; align-items: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #e9eff5, #f9fafc);
  color: #222;
}
h1 {
  margin: 30px 0 20px 0;
  font-size: 2rem;
  font-weight: 700;
  background: linear-gradient(90deg, #0056b3, #0091ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-align: center;
}
.chart-container {
  width: 90%;
  max-width: 1200px;
  height: 70vh;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  padding: 20px;
  margin-bottom: 40px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.chart-container:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}
iframe { display: none; }
</style>
</head>
<body>
<h1>Fiebertabelle (Kumulative Punkte)</h1>
<div class="chart-container">
  <canvas id="fieberChart"></canvas>
</div>

<iframe id="dashboardFrame" src="league-stats-dashboard.html"></iframe>

<script>
const iframe = document.getElementById("dashboardFrame");

iframe.onload = () => {
  try {
    const doc = iframe.contentDocument || iframe.contentWindow.document;
    const textarea = doc.getElementById("rawData");
    if (!textarea) throw new Error("Textarea #rawData not found in dashboard");

    const dashboardText = textarea.value.trim();
    const lines = dashboardText.split("\n");
    const players = [];
    const pointsByPlayer = {};
    lines.forEach(line => {
      const [name, ...rest] = line.split(/[\s,]+/);
      players.push(name);
      pointsByPlayer[name] = rest.map(Number);
    });

    const maxGames = Math.max(...Object.values(pointsByPlayer).map(arr => arr.length));
    const matchdays = Array.from({length: maxGames}, (_, i) => i + 1);
    const cumulativePoints = {};
    players.forEach(p => {
      let sum = 0;
      cumulativePoints[p] = pointsByPlayer[p].map(x => sum += x);
    });

    const colors = ['#E41A1C','#377EB8','#4DAF4A','#984EA3','#FF7F00','#A65628','#F781BF','#999999','#66C2A5','#FFD92F','#000000'];
    const selectedIndices = new Set();

    const datasets = players.map((p,i) => ({
      label: p,
      data: cumulativePoints[p],
      borderColor: colors[i % colors.length],
      backgroundColor: colors[i % colors.length],
      originalColor: colors[i % colors.length],
      originalBgColor: colors[i % colors.length],
      fill: false,
      pointRadius: 2,
      borderWidth: 2,
      spanGaps: true
    }));

    const ctx = document.getElementById('fieberChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels: matchdays, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: { usePointStyle: true, pointStyle: 'circle' },
            onClick: (e, legendItem) => {
              const index = legendItem.datasetIndex;
              if(selectedIndices.has(index)) selectedIndices.delete(index);
              else selectedIndices.add(index);

              const noneSelected = selectedIndices.size === 0;
              chart.data.datasets.forEach((ds,i) => {
                if(noneSelected || selectedIndices.has(i)) {
                  ds.borderColor = ds.originalColor;
                  ds.backgroundColor = ds.originalBgColor;
                  ds.borderWidth = 3;
                } else {
                  ds.borderColor = '#ccc';
                  ds.backgroundColor = '#ccc';
                  ds.borderWidth = 1;
                }
              });
              chart.update();
            }
          },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.raw}`
            }
          }
        },
        scales: {
          x: { title: { display: true, text: 'Spieltag' }, grid: { color: '#e0e0e0' } },
          y: { title: { display: true, text: 'Kumulative Punkte' }, beginAtZero: true, grid: { color: '#e0e0e0' } }
        }
      }
    });

  } catch(err) {
    console.error("Error loading dashboard data:", err);
  }
};
</script>
</body>
</html>
